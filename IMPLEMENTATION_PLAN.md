# 財產盤點系統 555 - 完整實現計劃

## 📋 項目概述
整合 GitHub Pages + Google Apps Script (GAS) + Google Spreadsheet 的行動盤點系統，支援掃描條碼、拍照上傳、數據修改和遷移。

---

## 🎯 核心功能需求

### 1. **條碼掃描**
- ✅ 用手機掃描財產標籤上的一維條碼
- ✅ 讀取並自動查詢 Spreadsheet 中的財產數據
- 技術：Web API (`navigator.mediaDevices`) 或整合掃描庫

### 2. **數據查詢與顯示**
- ✅ 掃描後自動查詢財產完整信息（15個欄位）
- ✅ 顯示所有欄位但只允許編輯以下欄位：
  - 存放地點
  - 備註
  - 可否報廢
  - 實物照片1/2/3 (可擴展)

### 3. **拍照功能**
- ✅ 直接調用手機相機拍照
- ✅ 選擇已有圖片
- ✅ 圖片預覽和刪除
- 照片存儲方案：
  - **方案A**：不限制數量（推薦 - 使用 Google Drive 存儲，Spreadsheet 存儲鏈接）
  - **方案B**：每個財產最多10張照片
- 技術：Google Drive API v3 + Spreadsheet API

### 4. **數據遷移**
- ✅ 保留 Code.gs 現有功能
- ✅ 支持將舊盤點數據的以下欄位遷移到新數據：
  - 存放地點
  - 備註
  - 可否報廢
  - 實物照片
- 避免重複盤點

### 5. **離線支持**
- Service Worker 支持離線模式（可選）
- 本地 IndexedDB 存儲臨時數據

---

## 🏗️ 技術架構

```
┌─────────────────────────────────────────────┐
│       GitHub Pages (Frontend)                │
│  ┌──────────────────────────────────────┐   │
│  │  index.html                          │   │
│  │  - 掃描/拍照界面                      │   │
│  │  - 表單編輯界面                      │   │
│  │  - 數據顯示界面                      │   │
│  └──────────────────────────────────────┘   │
│  ┌──────────────────────────────────────┐   │
│  │  js/app.js                           │   │
│  │  - UI 邏輯                           │   │
│  │  - GAS API 調用                      │   │
│  │  - 本地存儲管理                      │   │
│  └──────────────────────────────────────┘   │
│  ┌──────────────────────────────────────┐   │
│  │  css/style.css                       │   │
│  │  - 響應式設計（手機優先）             │   │
│  └──────────────────────────────────────┘   │
└─────────────────────────────────────────────┘
            ↓ HTTP 調用 ↓
┌─────────────────────────────────────────────┐
│   Google Apps Script (Backend)               │
│  ┌──────────────────────────────────────┐   │
│  │  Code.gs (保留原功能)                │   │
│  │  - 僅執行：單純擴展                  │   │
│  │  - 執行：註解跟比對                  │   │
│  └──────────────────────────────────────┘   │
│  ┌──────────────────────────────────────┐   │
│  │  API.gs (新增)                       │   │
│  │  - doGet/doPost HTTP 路由            │   │
│  │  - 查詢財產數據                      │   │
│  │  - 更新財產數據                      │   │
│  │  - 處理照片上傳                      │   │
│  └──────────────────────────────────────┘   │
│  ┌──────────────────────────────────────┐   │
│  │  SheetManager.gs (新增)              │   │
│  │  - 讀寫 Spreadsheet                  │   │
│  │  - 數據驗證和格式化                  │   │
│  │  - 列映射管理                        │   │
│  └──────────────────────────────────────┘   │
│  ┌──────────────────────────────────────┐   │
│  │  DriveManager.gs (新增)              │   │
│  │  - Google Drive 文件操作             │   │
│  │  - 照片上傳和管理                    │   │
│  └──────────────────────────────────────┘   │
└─────────────────────────────────────────────┘
            ↓ Spreadsheet API ↓
┌─────────────────────────────────────────────┐
│   Google Spreadsheet                         │
│  ┌──────────────────────────────────────┐   │
│  │  Sheet: "財產列表" (主表)            │   │
│  │  - 原始欄位 (15列)                   │   │
│  │  - 照片數據 (JSON 格式)              │   │
│  │  - 最後編輯時間戳                    │   │
│  └──────────────────────────────────────┘   │
│  ┌──────────────────────────────────────┐   │
│  │  Sheet: "舊註解" (遷移用)            │   │
│  │  - 用於數據遷移對比                  │   │
│  └──────────────────────────────────────┘   │
└─────────────────────────────────────────────┘
```

---

## 📁 文件結構

```
Asset_Inventory_555/
├── README.md                          # 項目說明（已有）
├── IMPLEMENTATION_PLAN.md             # 本文件
├── backend/
│   ├── Code.gs                        # 原有功能（保留）
│   ├── API.gs                         # 新增：HTTP API 端點
│   ├── SheetManager.gs                # 新增：Spreadsheet 操作
│   └── DriveManager.gs                # 新增：Google Drive 操作
├── docs/
│   ├── index.html                     # 主頁面
│   ├── js/
│   │   ├── app.js                     # 主應用邏輯
│   │   ├── barcode-scanner.js         # 條碼掃描模塊
│   │   ├── camera.js                  # 拍照模塊
│   │   ├── data-manager.js            # 本地數據管理
│   │   ├── sheet-api.js               # Spreadsheet API 封裝
│   │   └── ui.js                      # UI 交互控制
│   ├── css/
│   │   ├── style.css                  # 主樣式
│   │   └── responsive.css             # 響應式設計
│   ├── images/
│   │   └── (圖標和按鈕圖片)
│   ├── manifest.json                  # PWA 配置
│   └── service-worker.js              # 離線支持（可選）
└── tests/                             # 測試文件
    ├── test-api.gs
    └── test-barcode.html
```

---

## 🔄 工作流程

### 1️⃣ **掃描流程**
```
用戶掃描條碼
    ↓
[條碼識別] → barcode-scanner.js 提取編號
    ↓
[API 調用] → API.gs: getAssetByCode()
    ↓
[查詢結果] → 返回完整財產信息（JSON）
    ↓
[顯示界面] → 顯示只讀欄位 + 可編輯欄位
```

### 2️⃣ **拍照上傳流程**
```
用戶點擊拍照按鈕
    ↓
[相機調用] → camera.js 或直接選擇圖片
    ↓
[圖片預覽] → 用戶確認
    ↓
[上傳到 Drive] → DriveManager.gs 創建文件夾存儲
    ↓
[更新 Spreadsheet] → SheetManager.gs 保存圖片鏈接
    ↓
[本地同步] → 更新 IndexedDB 本地副本
```

### 3️⃣ **數據編輯流程**
```
用戶編輯欄位
    ↓
[表單驗證] → ui.js 驗證輸入
    ↓
[本地保存] → IndexedDB 臨時存儲
    ↓
[上傳確認] → 用戶點擊「保存」
    ↓
[API 調用] → API.gs: updateAsset()
    ↓
[寫入 Spreadsheet] → SheetManager.gs 更新數據
```

### 4️⃣ **數據遷移流程**
```
執行 Code.gs 的「執行：註解跟比對 (原地修改)」
    ↓
[查詢舊表] → 動態查找「[當前表名] (舊註解)」
    ↓
[對比數據] → 按財產編號匹配舊表數據
    ↓
[遷移欄位] → 存放地點、備註、可否報廢
    ↓
[遷移照片] → 若有照片鏈接，複製到新表
    ↓
[標記狀態] → 「新增」/「已報廢」標籤
```

---

## 🔐 權限要求

### Google Apps Script
- ✅ `spreadsheets` - 讀寫 Spreadsheet
- ✅ `drive` - 讀寫 Google Drive（照片存儲）
- ✅ `script` - 運行時權限

### GitHub Pages
- ✅ 需要發佈到 GitHub（或其他靜態主機）
- ✅ CORS 配置（GAS Web App 默認支持）

---

## 📸 照片存儲方案

### **推薦方案：不限制數量（方案A）**
```
Google Drive 結構：
Asset_Inventory_555/
├── 財產編號001/
│   ├── photo_1.jpg
│   ├── photo_2.jpg
│   ├── photo_3.jpg
│   └── ...
├── 財產編號002/
│   ├── photo_1.jpg
│   └── ...
└── ...

Spreadsheet 存儲格式（JSON 字符串）：
"photos": [
  {
    "url": "https://drive.google.com/uc?id=...",
    "name": "photo_1.jpg",
    "uploadDate": "2024-01-23",
    "size": "2048000"
  },
  ...
]
```

**優點：**
- 無限制擴展
- Google Drive 提供安全存儲
- 可以直接預覽
- 便於共享

---

## 🛠️ 開發步驟

### **Phase 1: 基礎架構 (Week 1)**
- [ ] 建立 GitHub Pages 靜態網站框架
- [ ] 設計響應式 UI (HTML/CSS)
- [ ] 建立 GAS API 骨架
- [ ] 配置 Google Drive 文件夾結構

### **Phase 2: 核心功能 (Week 2)**
- [ ] 實現條碼掃描功能
- [ ] 實現 Spreadsheet 查詢 API
- [ ] 實現拍照上傳功能
- [ ] 實現表單編輯和保存

### **Phase 3: 數據遷移 (Week 3)**
- [ ] 擴展 Code.gs 支持照片遷移
- [ ] 測試舊數據遷移流程
- [ ] 建立回滾機制

### **Phase 4: 優化和測試 (Week 4)**
- [ ] 離線支持 (Service Worker)
- [ ] 性能優化
- [ ] 跨設備測試
- [ ] 用戶文檔編寫

---

## 💡 額外功能建議

根據行業最佳實踐，以下功能值得考慮：

### ✨ **已納入的建議**
1. **批量上傳** - 允許一次上傳多張照片
2. **照片壓縮** - 自動壓縮大圖片以節省存儲
3. **編輯歷史** - 保留編輯記錄（時間戳、修改者）
4. **數據搜索** - 除條碼外，支持編號/名稱搜索
5. **導出功能** - 支持將盤點結果導出為 Excel/PDF

### 🎯 **進階建議**
6. **二維碼替代** - QR Code 支持（更多信息容量）
7. **多語言支持** - 英文/簡體中文選項
8. **用戶權限管理** - 不同角色的編輯權限
9. **數據同步** - 多設備實時同步
10. **審批工作流** - 盤點結果審核機制
11. **數據分析** - 資產使用率、遺失率統計
12. **集成通知** - 完成盤點後發送通知

---

## 🧪 測試計劃

```
測試項目                  覆蓋範圍
────────────────────────────────────────
條碼掃描                  • 不同格式條碼
                          • 網絡延遲模擬
數據查詢                  • 存在/不存在的編號
                          • 特殊字符處理
拍照上傳                  • 不同圖片格式/大小
                          • 網絡中斷續傳
表單編輯                  • 字段驗證
                          • 並發編輯
數據遷移                  • 部分舊數據
                          • 重複遷移場景
跨設備                    • iOS Safari
                          • Android Chrome
                          • 平板設備
```

---

## 📝 下一步行動

1. **確認需求**：
   - [ ] 照片存儲：選擇方案A（無限制）還是方案B（10張限制）？
   - [ ] 是否需要用戶登錄/權限管理？
   - [ ] 是否需要離線模式？

2. **準備環境**：
   - [ ] GitHub 倉庫設置（如還未建立）
   - [ ] Google Spreadsheet 和 GAS 編輯器訪問
   - [ ] Google Drive 文件夾創建

3. **開始開發**：
   - [ ] 建立初始 HTML 頁面框架
   - [ ] 編寫第一個 GAS API 端點
   - [ ] 建立本地開發環境

---

## 📞 常見問題

**Q: 照片存在哪裡？**
A: Google Drive 中的專用文件夾，Spreadsheet 僅存儲鏈接和元數據。

**Q: 沒有網絡可以使用嗎？**
A: 可以，Phase 4 中實現 Service Worker 支持離線模式，待有網絡時同步。

**Q: 舊數據如何遷移？**
A: 通過 Code.gs 的「比對功能」按編號匹配，自動遷移可編輯欄位。

**Q: 支持多少張照片？**
A: 推薦無限制（方案A），Google Drive 容量允許範圍內。

---

*最後更新：2026-01-23*
