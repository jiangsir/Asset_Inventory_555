<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="è²¡ç”¢ç›¤é»ç³»çµ± 555 - è¡Œå‹•ç›¤é»æ‡‰ç”¨">
    <meta name="theme-color" content="#2196F3">
    
    <title>è²¡ç”¢ç›¤é»ç³»çµ± 555</title>
    
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="manifest" href="manifest.json">
</head>
<body>
    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="navbar">
        <div class="navbar-brand">
            <h1>ğŸ“¦ è²¡ç”¢ç›¤é»ç³»çµ± 555 fix: æœ€è¿‘æŸ¥è©¢è¦å¯ä»¥é»æ“Š#3</h1>
        </div>
        <div class="navbar-menu">
            <button id="syncBtn" class="btn-icon" title="åŒæ­¥æ•¸æ“š" onclick="ui.syncData()">
                âŸ³ åŒæ­¥
            </button>
            <button id="settingsBtn" class="btn-icon" title="è¨­ç½®" onclick="ui.showSettings()">
                âš™ï¸ è¨­ç½®
            </button>
        </div>
    </nav>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <!-- 1. æƒæ/æœç´¢ç•Œé¢ -->
        <section id="scanSection" class="screen active">
            <div class="screen-header">
                <h2>ğŸ” æƒææˆ–æœç´¢è²¡ç”¢</h2>
            </div>

            <div class="screen-content">
                <!-- è¼¸å…¥æ¡† -->
                <div class="input-group">
                    <input 
                        type="text" 
                        id="assetCodeInput" 
                        class="input-field"
                        placeholder="æƒææ¢ç¢¼æˆ–è¼¸å…¥ç·¨è™Ÿ..."
                        autocomplete="off"
                    >
                    <script>
                      // INLINE FALLBACK: ç«‹å³ç¶å®š Enter è¡Œç‚ºï¼ˆé¿å… app.init æœªå®Œæˆæ™‚ç„¡æ³•ä½¿ç”¨ï¼‰
                      (function(){
                        const el = document.getElementById('assetCodeInput');
                        if (!el) return;
                        el.addEventListener('keydown', function(e){
                          if (e.key === 'Enter' || e.code === 'NumpadEnter'){
                            const v = (this.value || '').trim();
                            if (!v) return;
                            e.preventDefault();
                            // è‹¥ app.readyï¼Œå§”æ´¾çµ¦ app.queryAssetï¼›å¦å‰‡è¨˜éŒ„ä¸¦ç­‰å¾… app åˆå§‹åŒ–å®Œæˆ
                            if (window.app && typeof app.queryAsset === 'function') {
                              app.queryAsset(v);
                            } else {
                              console.debug('[inline-enter-fallback] app not ready, queuing query for', v);
                              // æš«å­˜æ–¼ window ä»¥ä¾¿ app.init å¾Œå¯è™•ç†ï¼ˆéç ´å£æ€§ï¼‰
                              window.__pendingAssetQuery = v;
                            }
                          }
                        });

                        // è‹¥é é¢è¼‰å…¥æ™‚å·²ç¶“æœ‰ pending queryï¼ˆä¾‹å¦‚æƒæå™¨ç›´æ¥è²¼ä¸Šï¼‰ï¼Œå˜—è©¦è‡ªå‹•è§¸ç™¼
                        el.addEventListener('input', () => {
                          const val = (el.value || '').trim();
                          if (val && /\n/.test(el.value)) {
                            const code = val.replace(/\s+/g,'');
                            if (window.app && typeof app.queryAsset === 'function') app.queryAsset(code);
                            else window.__pendingAssetQuery = code;
                          }
                        });
                      })();
                    </script>
                    <button class="btn-primary" onclick="scanner.openCamera()">
                        ğŸ“· æ‰“é–‹ç›¸æ©Ÿ
                    </button>
                </div>

                <!-- æƒæå¿«æ·éµæç¤º -->
                <div class="hint-box">
                    <p>ğŸ’¡ æŒ‰ <code>Enter</code> éµç›´æ¥æŸ¥è©¢</p>
                    <p>ğŸ’¡ æˆ–é»æ“Šã€Œæ‰“é–‹ç›¸æ©Ÿã€æƒææ¢ç¢¼</p>
                </div>

                <!-- æœ€è¿‘æƒææ­·å² -->
                <div class="recent-list" id="recentList">
                    <h3>æœ€è¿‘æŸ¥è©¢</h3>
                                        <div id="recentItemsContainer" class="items-grid">
                                                <!-- å‹•æ…‹ç”Ÿæˆ -->
                                        </div>
                                        <script>
                                            // INLINE: immediate recent backup render (non-destructive)
                                            (function(){
                                                try {
                                                    const key = 'recent_backup_v1';
                                                    const raw = localStorage.getItem(key);
                                                    if (!raw) return;
                                                    const items = JSON.parse(raw);
                                                    if (!items || !items.length) return;
                                                    const container = document.getElementById('recentItemsContainer');
                                                    if (!container) return;
                                                    // å¦‚æœ app å·²ç¶“æ¸²æŸ“ recentï¼Œå°±ä¸è¦†è“‹
                                                    if (container.children && container.children.length) return;
                                                    container.innerHTML = items.slice(0,6).map(asset => `\n                            <div class="item-card" data-code="${asset.code}" onclick="(window.app&&app.queryAsset)?app.queryAsset('${asset.code}'):null">\n                              <div class="item-card-code">${asset.code}</div>\n                              <div class="item-card-name">${(asset.model||asset.name)||''}</div>\n                              <div class="item-card-unit">${(asset.location||asset.unit)||''}</div>\n                            </div>\n                          `).join('');
                                                    console.debug('[inline-recent] rendered from local backup', items.length);
                                                } catch (e) {
                                                    console.debug('[inline-recent] failed', e);
                                                }
                                            })();
                                        </script>
                </div>

                <!-- å¿«é€Ÿæœç´¢å»ºè­° -->
                <div class="search-suggestions" id="searchSuggestions" style="display: none;">
                    <div id="suggestionsContainer" class="items-grid">
                        <!-- å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. è©³æƒ…æŸ¥çœ‹ç•Œé¢ -->
        <section id="detailSection" class="screen">
            <div class="screen-header">
                <button class="btn-back" onclick="ui.backToScan()">â† è¿”å›</button>
                <div style="display:flex;align-items:center;gap:12px;">
                    <h2 id="detailTitle">è²¡ç”¢è©³æƒ…</h2>
                    <div id="detailSheetName" class="sheet-name-badge" title="å·¥ä½œè¡¨åç¨±" aria-hidden="false">&nbsp;</div>
                  </div>
                <span class="spacer"></span>
            </div>

            <div class="screen-content">
                <!-- åªè®€æ¬„ä½é¡¯ç¤º -->
                <div class="details-readonly">
                    <h3>åŸºæœ¬ä¿¡æ¯</h3>
                    <div class="field-row">
                        <span class="label">è²¡ç”¢ç·¨è™Ÿ</span>
                        <span id="detail-assetCode" class="value">-</span>
                    </div>
                    <div class="field-row">
                        <span class="label">è²¡ç”¢åç¨±</span>
                        <span id="detail-assetName" class="value">-</span>
                    </div>
                    <div class="field-row">
                        <span class="label">è³¼ç½®æ—¥æœŸ</span>
                        <span id="detail-purchaseDate" class="value">-</span>
                    </div>
                    <div class="field-row">
                        <span class="label">ä½¿ç”¨å–®ä½</span>
                        <span id="detail-unit" class="value">-</span>
                    </div>
                    <div class="field-row">
                        <span class="label">å‹å¼å» ç‰Œ</span>
                        <span id="detail-model" class="value">-</span>
                    </div>
                    <div class="field-row">
                        <span class="label">æ•¸é‡</span>
                        <span id="detail-quantity" class="value">-</span>
                    </div>
                    <div class="field-row">
                        <span class="label">å–®åƒ¹</span>
                        <span id="detail-unitPrice" class="value">-</span>
                    </div>
                    <div class="field-row">
                        <span class="label">ç¸½åƒ¹</span>
                        <span id="detail-totalPrice" class="value">-</span>
                    </div>
                    <div class="field-row">
                        <span class="label">å¹´é™</span>
                        <span id="detail-lifespan" class="value">-</span>
                    </div>
                </div>

                <!-- å¯ç·¨è¼¯æ¬„ä½ -->
                <form id="editForm" class="form-editable">
                    <h3>ç›¤é»ä¿¡æ¯ (å¯ç·¨è¼¯)</h3>

                    <!-- å­˜æ”¾åœ°é»ï¼ˆåƒ…é¡¯ç¤ºï¼Œä¸å¯ä¿®æ”¹ï¼‰ -->
                    <div class="form-group">
                        <label>å­˜æ”¾åœ°é»</label>
                        <div id="edit-location" class="value-display" aria-readonly="true">-</div>
                        <small class="hint">è©²æ¬„ä½åƒ…ä¾›é¡¯ç¤ºï¼Œç„¡æ³•ç·¨è¼¯</small>
                    </div>

                    <!-- å‚™è¨» -->
                    <div class="form-group">
                        <label for="edit-remark">å‚™è¨»</label>
                        <textarea 
                            id="edit-remark" 
                            class="input-field textarea"
                            placeholder="è¼¸å…¥å‚™è¨»ä¿¡æ¯..."
                            rows="3"
                        ></textarea>
                        <small class="hint">è¨˜éŒ„è²¡ç”¢ç‹€æ³ã€æå‚·ç­‰ä¿¡æ¯</small>
                    </div>

                    <!-- å¯å¦å ±å»¢ -->
                    <div class="form-group">
                        <label for="edit-scrappable">å¯å¦å ±å»¢</label>
                        <select id="edit-scrappable" class="input-field">
                            <option value="">--- è«‹é¸æ“‡ ---</option>
                            <option value="æ˜¯">æ˜¯</option>
                            <option value="å¦">å¦</option>
                            <option value="å¾…è©•ä¼°">å¾…è©•ä¼°</option>
                        </select>
                    </div>

                    <!-- å¯¦ç‰©ç…§ç‰‡ -->
                    <div class="form-group">
                        <label>å¯¦ç‰©ç…§ç‰‡</label>
                        <div class="photos-section">
                            <div id="photoGallery" class="photo-gallery">
                                <!-- å‹•æ…‹ç”Ÿæˆ -->
                            </div>
                            <button type="button" class="btn-secondary" onclick="camera.addPhoto()">
                                â• æ·»åŠ ç…§ç‰‡
                            </button>
                        </div>
                        <small class="hint" id="photoHint">å·²ä¸Šå‚³ 0 å¼µ / æœ€å¤š 10 å¼µ</small>
                    </div>

                    <!-- ç·¨è¼¯ç‹€æ…‹ -->
                    <div class="form-status" id="formStatus" style="display: none;">
                        <p id="statusMessage"></p>
                    </div>

                    <!-- æ“ä½œæŒ‰éˆ• -->
                    <div class="form-actions">
                        <button type="reset" class="btn-secondary" onclick="ui.resetForm()">
                            â†º é‡ç½®
                        </button>
                        <button type="submit" class="btn-primary" onclick="ui.saveAsset(event)">
                            ğŸ’¾ ä¿å­˜
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- 3. è¨­ç½®ç•Œé¢ -->
        <section id="settingsSection" class="screen">
            <div class="screen-header">
                <button class="btn-back" onclick="ui.backToScan()">â† è¿”å›</button>
                <h2>âš™ï¸ è¨­ç½®</h2>
                <span class="spacer"></span>
            </div>

            <div class="screen-content">
                <div class="settings-group">
                    <h3>æ‡‰ç”¨è¨­ç½®</h3>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="offlineMode">
                            å•Ÿç”¨é›¢ç·šæ¨¡å¼ï¼ˆä½¿ç”¨æœ¬åœ°æ•¸æ“šï¼‰
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="showDebugInfo">
                            é¡¯ç¤ºèª¿è©¦ä¿¡æ¯
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="photoLimit">ç…§ç‰‡ä¸Šé™</label>
                        <select id="photoLimit" class="input-field">
                            <option value="0">ç„¡é™åˆ¶</option>
                            <option value="5">5 å¼µ</option>
                            <option value="10">10 å¼µ</option>
                            <option value="15">15 å¼µ</option>
                            <option value="20">20 å¼µ</option>
                        </select>
                    </div>
                </div>

                <div class="settings-group">
                    <h3>æ•¸æ“šç®¡ç†</h3>
                    <button class="btn-secondary" onclick="dataManager.exportLocalData()">
                        ğŸ“¥ å°å‡ºæœ¬åœ°æ•¸æ“š
                    </button>
                    <button class="btn-secondary" onclick="dataManager.clearLocalData()">
                        ğŸ—‘ï¸ æ¸…ç©ºæœ¬åœ°æ•¸æ“š
                    </button>
                </div>

                <div class="settings-group">
                    <h3>é—œäº</h3>
                    <p>
                        <strong>è²¡ç”¢ç›¤é»ç³»çµ± 555</strong><br>
                        ç‰ˆæœ¬ï¼š1.0.0<br>
                        æ›´æ–°æ—¥æœŸï¼š2026-01-23<br>
                        <a href="https://github.com/you/Asset_Inventory_555">GitHub å€‰åº«</a>
                    </p>
                </div>

                <div class="settings-actions">
                    <button class="btn-primary" onclick="ui.saveSettings()">
                        âœ“ ä¿å­˜è¨­ç½®
                    </button>
                </div>
            </div>
        </section>
    </div>

    <!-- ç›¸æ©Ÿé è¦½æ¨¡æ…‹æ¡† -->
    <div id="cameraModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“· ç›¸æ©Ÿ</h3>
                <button class="btn-close" onclick="camera.closeCamera()">âœ•</button>
            </div>
            <div class="modal-body">
                <video id="videoPreview" class="camera-preview" playsinline></video>
                <div class="camera-controls">
                    <button class="btn-primary" onclick="camera.takePhoto()">ğŸ“¸ æ‹ç…§</button>
                    <button class="btn-secondary" onclick="camera.closeCamera()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç…§ç‰‡é è¦½æ¨¡æ…‹æ¡† -->
    <div id="photoModal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>ç…§ç‰‡é è¦½</h3>
                <button class="btn-close" onclick="camera.closePhotoPreview()">âœ•</button>
            </div>
            <div class="modal-body">
                <div id="photoPreviewMeta" class="photo-meta" aria-live="polite"></div>
                <img id="photoPreview" src="" alt="ç…§ç‰‡é è¦½" class="photo-preview">

                <!-- å¦‚æœåŸåœ–ç„¡æ³• inline æˆ–ä½¿ç”¨è€…éœ€è¦ç›´æ¥é–‹å•Ÿ Driveï¼Œé¡¯ç¤ºæ­¤é€£çµ -->
                <a id="photoExternalLink" class="photo-external-link" href="#" target="_blank" rel="noopener" aria-hidden="true" style="display:none">åœ¨ Drive é–‹å•ŸåŸåœ–</a>

                <div class="modal-actions">
                    <button class="btn-primary" onclick="camera.confirmPhoto()">âœ“ ç¢ºèª</button>
                    <button class="btn-secondary" onclick="camera.cancelPhoto()">âœ• é‡æ–°æ‹ç…§</button>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è¼‰æŒ‡ç¤ºå™¨ -->
    <div id="loadingIndicator" class="loading-indicator" style="display: none;">
        <div class="spinner"></div>
        <p id="loadingText">åŠ è¼‰ä¸­...</p>
    </div>

    <!-- é€šçŸ¥æ¶ˆæ¯ -->
    <div id="notificationContainer" class="notification-container"></div>

    <!-- è…³æœ¬ -->
    <script src="js/data-manager.js"></script>
    <script src="js/sheet-api.js"></script>
    <script src="js/barcode-scanner.js"></script>
    <script src="js/camera.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/app.js"></script>
    <script>
      // é é¢åŠ è¼‰å®Œæˆå¾Œåˆå§‹åŒ–æ‡‰ç”¨
      document.addEventListener('DOMContentLoaded', function() {
        app.init();
      });
    </script>

    <!-- PWA Service Worker è¨»å†Š - èª¿è©¦æ™‚ç¦ç”¨ï¼Œé¿å…ç·©å­˜å•é¡Œ -->
    <!--
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js').catch(err => {
                console.log('Service Worker è¨»å†Šå¤±æ•—:', err);
            });
        }
    </script>
    -->
</body>
</html>
